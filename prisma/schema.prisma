// Ghost Job Detector - Prisma Schema
// Database: ghost-job-postgres

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Job posting sources (URLs or PDFs)
model Source {
  id                String   @id @default(cuid())
  kind              SourceKind // 'url' or 'pdf'
  url               String?  // Original URL for URL sources
  blobUrl           String?  // Blob storage URL for PDFs
  contentSha256     String   @unique // Hash for deduplication
  httpStatus        Int?     // HTTP response status for URLs
  firstSeenAt       DateTime @default(now())
  lastSeenAt        DateTime @updatedAt
  
  // Relations
  rawDocuments      RawDocument[]
  jobListings       JobListing[]
  events            Event[]
  
  // Indexes
  @@index([contentSha256])
  @@index([kind, firstSeenAt])
  @@map("sources")
}

// Raw document content from sources
model RawDocument {
  id            String   @id @default(cuid())
  sourceId      String
  storageUrl    String   // Blob storage URL
  mimeType      String   // 'text/html', 'application/pdf', etc.
  textContent   String?  // Extracted text content
  textSha256    String?  // Hash of extracted text
  createdAt     DateTime @default(now())
  
  // Relations
  source        Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([sourceId])
  @@index([textSha256])
  @@map("raw_documents")
}

// Normalized job posting data
model JobListing {
  id                String   @id @default(cuid())
  sourceId          String
  title             String
  company           String
  location          String?
  remoteFlag        Boolean  @default(false)
  postedAt          DateTime?
  canonicalUrl      String?  // Canonical job URL
  rawParsedJson     Json     // Original parsing results
  normalizedKey     String   @unique // Unique identifier for deduplication
  
  // WebLLM parsing fields
  parsingConfidence Decimal? @db.Decimal(3,2) // Confidence score (0.00-1.00)
  extractionMethod  String   @default("manual") // 'webllm', 'manual', 'hybrid'
  validationSources Json?    // Cross-validation source results
  crossReferenceData Json?   // Additional validation metadata
  parsingAttemptId  String?  // Reference to parsing attempt
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  source            Source     @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  parsingAttempt    ParsingAttempt? @relation("ParsingAttemptToJobListing", fields: [parsingAttemptId], references: [id])
  analyses          Analysis[]
  keyFactors        KeyFactor[]
  
  // Indexes
  @@index([sourceId])
  @@index([company])
  @@index([normalizedKey])
  @@index([postedAt])
  @@index([extractionMethod])
  @@index([parsingConfidence])
  @@index([parsingAttemptId])
  @@map("job_listings")
}

// Analysis results and scoring - Phase 1 optimized
model Analysis {
  id                String   @id @default(cuid())
  jobListingId      String
  score             Decimal  @db.Decimal(3,2) // 0.00 to 1.00 (Phase 1: optimized precision)
  verdict           AnalysisVerdict
  reasonsJson       Json     // Detailed reason codes and factors
  modelVersion      String
  processingTimeMs  Int?     // Analysis duration
  createdAt         DateTime @default(now())
  
  // Detailed analyzer processing data
  algorithmAssessment Json?   // Ghost probability, model confidence, assessment text
  riskFactorsAnalysis Json?   // Warning signs, positive indicators, detailed factors
  recommendation      Json?   // Final recommendation and reasoning
  analysisDetails     Json?   // Analysis ID, processing metadata, technical details
  modelConfidence     Decimal? @db.Decimal(3,2) // Model confidence score (0-1) - Phase 1: optimized precision
  // REMOVED: ghostProbability (redundant with score field)
  // REMOVED: analysisId (redundant with primary key id)
  
  // Relations
  jobListing        JobListing @relation(fields: [jobListingId], references: [id], onDelete: Cascade)
  
  // Indexes - Phase 1 optimized
  @@index([jobListingId, createdAt(sort: Desc)])
  @@index([verdict])
  @@index([modelVersion])
  @@index([score])  // Phase 1: Changed from ghostProbability to score
  // REMOVED: @@index([analysisId]) - field removed
  @@map("analyses")
}

// Risk and positive factors for each job - Phase 1 optimized
model KeyFactor {
  id                String     @id @default(cuid())
  jobListingId      String
  factorType        FactorType // 'risk' or 'positive'
  factorDescription String
  impactScore       Decimal    @db.Decimal(3,2) // Impact weight - Phase 1: optimized precision
  createdAt         DateTime   @default(now())
  
  // Relations
  jobListing        JobListing @relation(fields: [jobListingId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([jobListingId])
  @@index([factorType])
  @@map("key_factors")
}

// Company intelligence and metrics
model Company {
  id                    String   @id @default(cuid())
  name                  String   @unique
  normalizedName        String   @unique // Cleaned company name for deduplication
  totalPostings         Int      @default(0)
  avgGhostProbability   Decimal  @db.Decimal(5,4) @default(0)
  lastAnalyzedAt        DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Indexes
  @@index([totalPostings])
  @@map("companies")
}

// Parsing corrections for machine learning
model ParsingCorrection {
  id                String   @id @default(cuid())
  sourceUrl         String   
  originalTitle     String?  // What the parser extracted
  correctTitle      String?  // What it should have been
  originalCompany   String?  // What the parser extracted
  correctCompany    String?  // What it should have been
  parserUsed        String   // Which parser was used
  parserVersion     String   // Version of the parser
  correctionReason  String?  // Why correction was needed
  domainPattern     String?  // Domain pattern for learning
  urlPattern        String?  // URL pattern for learning
  confidence        Decimal  @db.Decimal(3,2) @default(1.0) // Confidence in correction
  correctedBy       String?  // User or system that made correction
  isVerified        Boolean  @default(false) // Whether correction has been verified
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Indexes for learning queries
  @@index([sourceUrl])
  @@index([parserUsed, parserVersion])
  @@index([domainPattern])
  @@index([correctedBy])
  @@index([isVerified])
  @@map("parsing_corrections")
}

// Manual job listing corrections by users - REMOVED in Phase 1 optimization  
// UI feature was removed in v0.1.5 per CLAUDE.md, table no longer needed

// Parsing attempts tracking for WebLLM performance
model ParsingAttempt {
  id               String   @id @default(cuid()) // UUID primary key
  sourceUrl        String   // URL being parsed
  attemptedAt      DateTime @default(now())
  successStatus    Boolean  @default(false)
  errorMessage     String?  // Error details if failed
  processingTimeMs Int?     // Time taken for parsing
  extractionMethod String   // 'webllm', 'fallback', etc.
  confidenceScore  Decimal? @db.Decimal(3,2) // Overall extraction confidence
  validationData   Json?    // Cross-validation results
  userAgentUsed    String?  // Browser user agent for debugging
  ipAddress        String?  // Client IP for rate limiting
  
  // Relations
  jobListings      JobListing[] @relation("ParsingAttemptToJobListing")
  
  // Indexes
  @@index([sourceUrl])
  @@index([attemptedAt])
  @@index([successStatus])
  @@index([extractionMethod])
  @@map("parsing_attempts")
}

// Algorithm feedback and learning data - REMOVED in Phase 1 optimization
// Table was unused with no API references, removed to save storage and improve performance

// System events and audit trail
model Event {
  id          String     @id @default(cuid())
  kind        EventKind
  refTable    String?    // Referenced table name
  refId       String?    // Referenced record ID
  meta        Json?      // Event metadata
  createdAt   DateTime   @default(now())
  
  // Relations
  source      Source?    @relation(fields: [refId], references: [id])
  
  // Indexes
  @@index([kind, createdAt])
  @@index([refTable, refId])
  @@map("events")
}

// User accounts and authentication
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  role          UserRole @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?
  
  // Indexes
  @@index([email])
  @@map("users")
}

// Enums
enum SourceKind {
  url
  pdf
}

enum AnalysisVerdict {
  likely_real
  uncertain  
  likely_ghost
}

enum FactorType {
  risk
  positive
}

enum EventKind {
  source_submitted
  document_processed
  analysis_completed
  analysis_failed
  queue_processed
  admin_action
  agent_validate
  agent_promotion
}

enum UserRole {
  USER
  ADMIN
  ENTERPRISE
}